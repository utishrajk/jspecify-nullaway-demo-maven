version: '3.8'

services:
  # Jenkins
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins-server
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount minikube certs for kubectl access if needed
      - ${HOME}/.minikube:/var/jenkins_home/.minikube
    networks:
      - devops-net
    restart: always

  # Nexus
  nexus:
    image: sonatype/nexus3:latest
    container_name: nexus-server
    ports:
      - "8081:8081"
    volumes:
      - nexus_data:/nexus-data
    networks:
      - devops-net
    restart: always

  # Splunk
  splunk:
    image: splunk/splunk:latest
    container_name: splunk-server
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_PASSWORD=password
    ports:
      - "8000:8000"
      - "8088:8088"  # HEC Port
    volumes:
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
    networks:
      - devops-net
    restart: always

  # Portainer
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - devops-net
    restart: always

  # Log Proxy (Socat)
  log-proxy:
    image: alpine/socat
    container_name: log-proxy
    command: tcp-listen:8888,fork,reuseaddr tcp-connect:splunk-server:8088
    ports:
      - "8888:8888"
    depends_on:
      - splunk
    networks:
      - devops-net
    restart: always

  # Nginx Reverse Proxy
  nginx-proxy:
    image: nginx:alpine
    container_name: devops-proxy
    network_mode: host # Needs host networking to access Minikube IPs
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    restart: always

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - devops-net
    restart: always

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - devops-net
    restart: always

volumes:
  jenkins_home:
  nexus_data:
  splunk_etc:
  splunk_var:
  portainer_data:
  prometheus_data:
  grafana_data:

networks:
  devops-net:
    driver: bridge
